name: update-live-roles

on:
  schedule:
    # 11:00 PM IST daily (17:30 UTC)
    - cron: '30 17 * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  actions: write

concurrency:
  group: live-roles-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-roles:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install live roles kit deps
        run: npm --prefix packages/hugo-live-roles-kit-v0.1 ci

      - name: Check config
        run: npm run roles:check

      - name: Fetch roles
        env:
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          JOOBLE_API_KEY: ${{ secrets.JOOBLE_API_KEY }}
        run: npm run fetch:roles

      - name: Commit changes
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if [ -z "${PERSONAL_TOKEN}" ]; then
            echo "Missing required secret: PERSONAL_TOKEN"
            exit 1
          fi
          if [ -n "$(git status --porcelain data/roles/pavan.yml data/roles/pooja.yml roles-kit/sources/pavan.roles-sources.yml roles-kit/sources/pooja.roles-sources.yml)" ]; then
            BRANCH="${GITHUB_REF_NAME:-main}"
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git remote set-url origin "https://x-access-token:${PERSONAL_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git add data/roles/pavan.yml data/roles/pooja.yml roles-kit/sources/pavan.roles-sources.yml roles-kit/sources/pooja.roles-sources.yml
            git commit -m "chore(ci): update live roles data (pavan + pooja)"
            for attempt in 1 2 3; do
              if git pull --rebase origin "$BRANCH" && git push origin "HEAD:$BRANCH"; then
                echo "Push succeeded on attempt $attempt."
                exit 0
              fi
              echo "Push failed on attempt $attempt. Retrying..."
              git rebase --abort || true
              sleep $((attempt * 5))
            done
            echo "Failed to push after 3 attempts."
            exit 1
          else
            echo "No changes to commit."
          fi
